# =============================================================================
# Sealed Secrets Configuration
# =============================================================================
# These SealedSecrets are encrypted using the cluster's sealed-secrets
# controller public key. They can only be decrypted by the controller
# running in the target cluster.
#
# To re-seal secrets after rotation:
#   1. Create a regular Kubernetes secret
#   2. Use kubeseal to encrypt it:
#      kubeseal --format yaml --cert <cert.pem> < secret.yaml > sealed-secret.yaml
#   3. Update the values.yaml with the new encryptedData
#
# Controller: sealed-secrets-controller (kube-system)
# =============================================================================
{{- if .Values.sealedSecrets.enabled }}

# -----------------------------------------------------------------------------
# PostgreSQL Database Secret
# -----------------------------------------------------------------------------
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: maria-postgres-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "guestbook.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
spec:
  encryptedData:
    password: {{ .Values.sealedSecrets.postgres.encryptedPassword }}
  template:
    metadata:
      name: maria-postgres-secret
      namespace: {{ .Release.Namespace }}
      labels:
        {{- include "guestbook.labels" . | nindent 8 }}
    type: Opaque

---
# -----------------------------------------------------------------------------
# Redis Cache Secret
# -----------------------------------------------------------------------------
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: maria-redis-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "guestbook.labels" . | nindent 4 }}
    app.kubernetes.io/component: cache
spec:
  encryptedData:
    password: {{ .Values.sealedSecrets.redis.encryptedPassword }}
  template:
    metadata:
      name: maria-redis-secret
      namespace: {{ .Release.Namespace }}
      labels:
        {{- include "guestbook.labels" . | nindent 8 }}
    type: Opaque

---
# -----------------------------------------------------------------------------
# GHCR Docker Registry Secret
# -----------------------------------------------------------------------------
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: ghcr-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "guestbook.labels" . | nindent 4 }}
    app.kubernetes.io/component: registry
spec:
  encryptedData:
    .dockerconfigjson: {{ .Values.sealedSecrets.ghcr.encryptedDockerConfig }}
  template:
    metadata:
      name: ghcr-secret
      namespace: {{ .Release.Namespace }}
      labels:
        {{- include "guestbook.labels" . | nindent 8 }}
    type: kubernetes.io/dockerconfigjson

{{- end }}
