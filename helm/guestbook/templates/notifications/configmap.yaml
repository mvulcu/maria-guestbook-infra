# =============================================================================
# ArgoCD Notifications - ConfigMap
# =============================================================================
# Configures triggers and templates for notifications.
# Deployed to 'argocd' namespace to configure the controller.
# =============================================================================
{{- if .Values.notifications.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/managed-by: helm
data:
  # ---------------------------------------------------------------------------
  # Service Configuration (Generic Webhook for Discord)
  # ---------------------------------------------------------------------------
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
    - name: Content-Type
      value: application/json
    default-method: POST

  # ---------------------------------------------------------------------------
  # Triggers (When to send notifications)
  # ---------------------------------------------------------------------------
  # Sync Succeeded
  trigger.on-sync-succeeded: |
    - description: Application sync succeeded
      send: [discord]
      when: app.status.operationState.phase in ['Succeeded']

  # Sync Failed
  trigger.on-sync-failed: |
    - description: Application sync failed
      send: [discord]
      when: app.status.operationState.phase in ['Error', 'Failed']

  # Application Degraded
  trigger.on-health-degraded: |
    - description: Application health degraded
      send: [discord]
      when: app.status.health.status == 'Degraded'

  # ---------------------------------------------------------------------------
  # Templates (What to send)
  # ---------------------------------------------------------------------------
  template.discord: |
    body:
      content: |
        âœ… **ArgoCD Notification**

        Application: **{{ "{{" }}.app.metadata.name{{ "}}" }}**
        Sync Status: {{ "{{" }}.app.status.operationState.phase{{ "}}" }}
        Health Status: {{ "{{" }}.app.status.health.status{{ "}}" }}

        [Open ArgoCD]({{ "{{" }}.context.argocdUrl{{ "}}" }}/applications/{{ "{{" }}.app.metadata.name{{ "}}" }})
{{- end }}
