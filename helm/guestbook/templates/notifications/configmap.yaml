# =============================================================================
# ArgoCD Notifications - ConfigMap
# =============================================================================
# Configures triggers and templates for notifications.
# Deployed to 'argocd' namespace to configure the controller.
# =============================================================================
{{- if .Values.notifications.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
  labels:
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/managed-by: helm
data:
  # ---------------------------------------------------------------------------
  # Service Configuration (Generic Webhook for Discord)
  # ---------------------------------------------------------------------------
  service.webhook.discord: |
    url: $discord-webhook-url
    headers:
    - name: Content-Type
      value: application/json
    default-method: POST

  # ---------------------------------------------------------------------------
  # Triggers (When to send notifications)
  # ---------------------------------------------------------------------------
  # Sync Succeeded
  trigger.on-sync-succeeded: |
    - description: Application sync succeeded
      send: [discord]
      when: app.status.operationState.phase in ['Succeeded']

  # Sync Failed
  trigger.on-sync-failed: |
    - description: Application sync failed
      send: [discord]
      when: app.status.operationState.phase in ['Error', 'Failed']

  # Sync Running
  trigger.on-sync-running: |
    - description: Application sync running
      send: [discord]
      when: app.status.operationState.phase in ['Running']

  # Application Degraded
  trigger.on-health-degraded: |
    - description: Application health degraded
      send: [discord]
      when: app.status.health.status == 'Degraded'

  # Application Deployed (Health Restored)
  trigger.on-deployed: |
    - description: Application deployed successfully
      send: [discord]
      when: app.status.operationState.phase in ['Succeeded'] and app.status.health.status == 'Healthy'

  # ---------------------------------------------------------------------------
  # Templates (What to send)
  # ---------------------------------------------------------------------------
  template.discord: |
    webhook:
      discord:
        method: POST
        body: |
          {"content": "âœ… **ArgoCD Notification**\n\nApplication: **{{ "{{" }}.app.metadata.name{{ "}}" }}**\nSync: {{ "{{" }}.app.status.operationState.phase{{ "}}" }}\nHealth: {{ "{{" }}.app.status.health.status{{ "}}" }}"}
{{- end }}
